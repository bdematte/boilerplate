#!/bin/bash -e

REPO_ROOT=$(git rev-parse --show-toplevel)

source $REPO_ROOT/test/lib.sh

repo=$(empty_repo)
add_cleanup $repo
test_project="file-generate"

# TODO: test REPO_NAME detection by setting an appropriately-formatted
# git remote
export REPO_NAME=${0##*/}

bootstrap_project $repo ${test_project} openshift/golang-osd-operator
cd $repo
export GOPATH=$GOPATH:`pwd`

make update-boilerplate
make check-generate || echo "Project is not committed. Checks failed as expected"

git add -A
git commit -m "initial commit"

make check-generate || echo "Generated files are not committed. Checks failed as expected"

if [ ! -f src/test/test-generation ] || [ ! -f src/test/subfolder/test-generation-subfolder ] ; then
    echo "Generation didn't work properly"
    exit 1
fi

git add -A
git commit -m "commit generated files"

make check-generate
